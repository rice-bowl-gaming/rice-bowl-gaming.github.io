// combined-all.js â€” Universal login handler + tab cloak + WebSocket + analytics

let backup_icon;
let backup_name;
let socket;
let panicurl;

// ========================
// COOKIE UTILITY
// ========================
function getCookie(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(";");
  for (let i = 0; i < ca.length; i++) {
    let c = ca[i].trim();
    if (c.indexOf(name) === 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

// ========================
// WEBSOCKET SETUP
// ========================
if (location.origin.includes("https")) {
  socket = new WebSocket(`wss://${location.host}/socket`);
} else {
  socket = new WebSocket(`ws://${location.host}/socket`);
}

socket.addEventListener("open", () => {
  let cookies = document.cookie.split("; ");
  for (let i = 0; i < cookies.length; i++) {
    if (cookies[i].trim().startsWith("token=")) {
      socket.send(cookies[i].trim());
    }
  }
});

socket.addEventListener("message", (event) => {
  if (event.data === "ping") {
    socket.send(`pong${location.pathname.includes("/semag/") ? location.pathname.split("/")[2] : ""}`);
    return;
  }
  if (event.data.startsWith("announce.")) {
    let styles = document.createElement("style");
    styles.innerHTML = `
      @import url("https://fonts.googleapis.com/css2?family=Prompt:wght@300&display=swap");
      .announce {
        font-family: "Prompt", sans-serif;
        position: absolute;
        margin-left: auto;
        margin-right: auto;
        top: 10px;
        z-index: 10000000;
        background-color: #a53026;
        padding: 10px;
        width: max-content;
        border-radius: 10px;
        left: 0;
        right: 0;
        border-color: #f74f40;
        border-width: 5px;
        border-style: solid;
        max-width: 60%;
        font-size: 16px;
        color: white;
      }
      @keyframes FadeIn { 0% { opacity: 0; } 100% { opacity: 1; } }
      @keyframes FadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }
    `;
    let announcement = document.createElement("div");
    announcement.innerText = event.data.substring(9);
    announcement.setAttribute("class", "announce");
    announcement.style.opacity = "0";
    announcement.style.animation = "FadeIn 1s ease-in-out forwards";
    document.head.appendChild(styles);
    document.body.appendChild(announcement);
    setTimeout(() => {
      announcement.style.animation = "FadeOut 1s ease-in-out forwards";
      setTimeout(() => {
        announcement.remove();
        styles.remove();
      }, 1000);
    }, 14000);
  }
});

// ========================
// TAB CLOAK FUNCTIONS
// ========================
function setCloak(name, icon) {
  var tabicon = getCookie("tabicon");
  if (tabicon || icon) {
    var link = document.querySelector("link[rel~='icon']");
    if (link) {
      if (link.href !== icon) backup_icon = link;
      while (document.querySelector("link[rel~='icon']")) {
        document.querySelector("link[rel~='icon']").remove();
      }
    }
    link = document.querySelector("link[rel~='shortcut icon']");
    if (link) {
      if (link.href !== icon) backup_icon = link;
      while (document.querySelector("link[rel~='shortcut icon']")) {
        document.querySelector("link[rel~='shortcut icon']").remove();
      }
    }
    link = document.createElement("link");
    link.rel = "icon";
    document.head.appendChild(link);
    link.href = tabicon;
    if (name) link.href = icon;
  }
  var tabname = getCookie("tabname");
  backup_name = document.title;
  if (tabname) document.title = tabname;
  if (name) document.title = name;
  panicMode();
}

function panicMode() {
  panicurl = getCookie("panicurl");
  if (panicurl === "") panicurl = "https://google.com";
}

// ========================
// KEYBOARD SHORTCUTS
// ========================
let listofchars = "";
document.addEventListener("keydown", (e) => {
  listofchars = listofchars + e.key;
  if (listofchars.length > 20) {
    listofchars = listofchars.substring(e.key.length);
  }
  if (listofchars.includes("safemode")) {
    window.location.href = panicurl;
    listofchars = "";
  } else if (listofchars.includes("debugplz")) {
    if (getCookie("debugging") == 1) {
      document.cookie = "debugging=0;";
      alert("debugging off!");
    } else {
      document.cookie = "debugging=1";
      alert("debugging on!");
    }
    listofchars = "";
  }
});

// ========================
// DEBUG MODE
// ========================
if (getCookie("debugging") == 1) {
  const debugscript = document.createElement("script");
  debugscript.setAttribute("src", "/js/debug.js");
  document.head.append(debugscript);
}

// ========================
// TAB VISIBILITY DISGUISE
// ========================
addEventListener("visibilitychange", () => {
  if (localStorage.getItem("selenite.tabDisguise") === "true") {
    if (document.visibilityState === "hidden") {
      setCloak("Google", "https://www.google.com/favicon.ico");
    } else {
      if (!backup_icon) {
        let icon = document.createElement("link");
        icon.rel = "icon";
        let link = document.querySelector("link[rel~='icon']");
        if (link) {
          backup_icon = link;
          while (document.querySelector("link[rel~='icon']")) {
            document.querySelector("link[rel~='icon']").remove();
          }
        }
        link = document.querySelector("link[rel~='shortcut icon']");
        if (link) {
          backup_icon = link;
          while (document.querySelector("link[rel~='shortcut icon']")) {
            document.querySelector("link[rel~='shortcut icon']").remove();
          }
        }
        document.head.appendChild(icon);
        icon.href = location.origin + "/favicon.ico";
      } else {
        document.head.appendChild(backup_icon);
      }
      document.title = backup_name;
    }
  }
});

// ========================
// BLOCK TAB CLOSE (for games)
// ========================
if (location.pathname.substring(1).includes("semag") && localStorage.getItem("selenite.blockClose") === "true") {
  window.onbeforeunload = function () {
    return "";
  };
}

// ========================
// FPS COUNTER
// ========================
function fps() {
  var script = document.createElement("script");
  script.onload = function () {
    var stats = new Stats();
    document.body.appendChild(stats.dom);
    requestAnimationFrame(function loop() {
      stats.update();
      requestAnimationFrame(loop);
    });
    localStorage.setItem("fps", true);
  };
  script.src = "https://cdn.jsdelivr.net/gh/mrdoob/stats.js@master/build/stats.min.js";
  document.head.appendChild(script);
}
if (localStorage.getItem("fps")) fps();

// ========================
// POLYFILL
// ========================
var polyfillScript = document.createElement("script");
polyfillScript.src = "https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?version=4.8.0";
document.head.appendChild(polyfillScript);

// ========================
// DOM CONTENT LOADED INIT
// ========================
document.addEventListener("DOMContentLoaded", () => {
  setCloak();
  
  // Analytics
  let plausible = document.createElement("script");
  plausible.setAttribute("event-domain", location.host);
  plausible.setAttribute("defer", "");
  plausible.setAttribute("src", "/js/analytics.js");
  plausible.setAttribute("data-domain", "selenite.cc");
  document.head.appendChild(plausible);
}, false);

// ========================
// LOGIN / AUTH SYSTEM
// ========================
(async () => {
  const loginPage = '/login.html';
  const homePage = '/index.html';
  const googleForm = 'https://forms.gle/xoYAygpNXhdkPsGm8'; // Replace with your Google Form
  let allowedUsers = [];

  // Load allowed users from /user.json
  try {
    const res = await fetch('/user.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('Cannot fetch user.json');
    const data = await res.json();
    allowedUsers = data.allowedUsers || [];
  } catch (err) {
    console.error('Error loading allowed users:', err);
    if (!location.pathname.endsWith('login.html')) {
      window.location.href = loginPage;
    }
    return;
  }

  const username = localStorage.getItem('username');

  // LOGIN PAGE LOGIC
  if (location.pathname.endsWith('login.html')) {
    const loginBtn = document.getElementById('loginBtn');
    const usernameInput = document.getElementById('username');

    // Auto-redirect if already logged in
    if (username && allowedUsers.includes(username)) {
      window.location.href = homePage;
      return;
    }

    const showMessage = (text, type) => {
      const el = document.getElementById('message');
      el.textContent = text;
      el.className = 'message ' + type;
      el.style.display = 'block';
    };

    const login = () => {
      const userVal = usernameInput.value.trim();
      if (!userVal) return showMessage('Please enter a username', 'error');

      const isEightDigits = /^\d{8}$/.test(userVal);
      if (isEightDigits) {
        if (allowedUsers.includes(userVal)) {
          localStorage.setItem('username', userVal);
          window.location.href = homePage;
        } else {
          window.location.href = googleForm;
        }
        return;
      }
      showMessage('School administrators are not authorized', 'error');
    };

    loginBtn.addEventListener('click', login);
    usernameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') login();
    });
    return;
  }

  // PROTECT ALL OTHER PAGES
  if (!username || !allowedUsers.includes(username)) {
    window.location.href = loginPage;
  }
})();
